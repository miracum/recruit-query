image: docker:git

variables:
  DOCKER_REGISTRY: docker.miracum.org
  IMAGE_PATH: $DOCKER_REGISTRY/uc1-recruit/query

.docker_registry:
  before_script:
    - echo $REGISTRY_PASSWORD | docker login -u $REGISTRY_USERNAME $DOCKER_REGISTRY --password-stdin
  after_script:
    - docker logout $DOCKER_REGISTRY

stages:
  - lint
  - version
  - build
  - test
  - release
  - deploy

determine next version:
  image: docker.miracum.org/miracum-devops/semantic-release:latest
  stage: version
  script:
    - npx semantic-release --dry-run
    - test -e .VERSION || (echo $(git describe --abbrev=0 --tags | tr -d v) > .VERSION && touch .NORELEASE)
  artifacts:
    paths:
      - .VERSION
      - .NORELEASE
    expire_in: 1 hour
  except:
    - tags

lint dockerfile:
  stage: lint
  image: hadolint/hadolint:latest-debian
  script:
    - hadolint Dockerfile
  only:
    changes:
      - "*Dockerfile"
  except:
    - tags

lint compose:
  stage: lint
  image:
    name: cytopia/yamllint:latest
    entrypoint: ["/bin/sh", "-c"]
  script:
    - yamllint deploy/docker-compose*.yml
  only:
    changes:
      - "deploy/*"
  except:
    - tags

build:
  stage: build
  extends: .docker_registry
  script:
    - export VERSION=$(cat .VERSION)
    - docker build -t $IMAGE_PATH:$CI_COMMIT_SHORT_SHA --build-arg VERSION=$VERSION .
    - docker push $IMAGE_PATH:$CI_COMMIT_SHORT_SHA
  except:
    - tags

scan with trivy:
  stage: test
  before_script:
    - apk add --no-cache curl
    - export VERSION=$(curl --silent "https://api.github.com/repos/aquasecurity/trivy/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
    - echo $VERSION
    - wget https://github.com/aquasecurity/trivy/releases/download/v${VERSION}/trivy_${VERSION}_Linux-64bit.tar.gz
    - tar zxvf trivy_${VERSION}_Linux-64bit.tar.gz
  allow_failure: true
  script:
    - ./trivy --exit-code 0 --severity HIGH --no-progress $IMAGE_PATH:$CI_COMMIT_SHORT_SHA
    - ./trivy --exit-code 1 --severity CRITICAL --no-progress $IMAGE_PATH:$CI_COMMIT_SHORT_SHA
  cache:
    paths:
      - $CI_PROJECT_DIR/.trivycache/
  except:
    - tags


push to harbor:
  stage: release
  extends: .docker_registry
  script:
    - export IMAGE_TAG=v$(cat .VERSION)
    - docker pull $IMAGE_PATH:$CI_COMMIT_SHORT_SHA
    - docker tag $IMAGE_PATH:$CI_COMMIT_SHORT_SHA $IMAGE_PATH:$IMAGE_TAG
    - docker push $IMAGE_PATH:$IMAGE_TAG
  only:
    - master

gitlab release:
  image: docker.miracum.org/miracum-devops/semantic-release
  stage: release
  script:
    - npx semantic-release
  only:
    - master

staging:
  image:
    name: docker/compose:1.25.0
    entrypoint: ["/bin/sh", "-c"]
  stage: deploy
  extends: .docker_registry
  script:
    - export IMAGE_TAG=v$(cat .VERSION)
    - docker-compose -p staging-$CI_PROJECT_NAME -f deploy/docker-compose.staging.yml --verbose pull
    - docker-compose -p staging-$CI_PROJECT_NAME -f deploy/docker-compose.staging.yml --verbose up -d
  environment:
    name: staging
    url: https://recruit.miracum.org/query
  only:
    - master
  tags:
    - ume
    - uc1
    - recruit
    - staging
